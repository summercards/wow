// Main Game Entry
window.onload = function() {
  console.log('Game loading...');

  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = WoW.Core.Constants.CANVAS_WIDTH;
  canvas.height = WoW.Core.Constants.CANVAS_HEIGHT;

  console.log('Canvas initialized');

  // Initialize Core & Systems
  const input = new WoW.Core.Input();
  const events = new WoW.Core.EventEmitter();
  const battleSystem = new WoW.Systems.BattleSystem(events);
  const vfxSystem = new WoW.Systems.VFXSystem(battleSystem);
  const skillSystem = new WoW.Systems.SkillSystem(battleSystem, vfxSystem);
  const inventorySystem = new WoW.Systems.InventorySystem(input);
  const careerSelection = new WoW.Systems.CareerSelection();

  console.log('Systems initialized');

  WoW.State.BattleSystem = battleSystem;
  WoW.State.SkillSystem = skillSystem;
  WoW.State.VFXSystem = vfxSystem;

  // Initialize All Career Entities
  const warrior = new WoW.Content.Warrior(100, 300);
  const mage = new WoW.Content.Mage(50, 150);
  const priest = new WoW.Content.Priest(50, 250);
  const rogue = new WoW.Content.Rogue(50, 350);
  const hunter = new WoW.Content.Hunter(50, 450);

  console.log('Career entities created');

  // Career mapping for easy access
  const careers = {
      warrior: warrior,
      mage: mage,
      priest: priest,
      rogue: rogue,
      hunter: hunter
  };

  // Current controlled player
  let player = null;
  WoW.State.Player = null; // Expose globally for entities to check

  // Controller for current player
  const controller = new WoW.Core.Controller(input);

  // Initial Item Distribution for Warrior (default)
  warrior.inventory[0] = WoW.Core.Items.create(101); // 坚韧之剑
  warrior.inventory[1] = WoW.Core.Items.create(103); // 板甲头盔
  warrior.inventory[2] = WoW.Core.Items.create(201); // 大地之斧
  warrior.inventory[3] = WoW.Core.Items.create(203); // 勇气头盔
  warrior.inventory[4] = WoW.Core.Items.create(1001); // 逐风者之剑
  warrior.inventory[5] = WoW.Core.Items.create(106); // 防御者护腕
  warrior.inventory[6] = WoW.Core.Items.create(105); // 秘术师的戒指
  warrior.inventory[7] = WoW.Core.Items.create(204); // 智慧项链
  warrior.inventory[8] = WoW.Core.Items.create(1002); // 炎魔之手
  warrior.inventory[9] = WoW.Core.Items.create(205); // 刺客的匕首
  warrior.inventory[10] = WoW.Core.Items.create(206); // 疾风弓

  // Automatically equip some starting gear for better stats
  inventorySystem.equipItem(warrior, 0); // Equip 坚韧之剑
  inventorySystem.equipItem(warrior, 1); // Equip 板甲头盔

  // Group Setup
  WoW.State.Party = [warrior, mage, priest, rogue, hunter];

  // Enemies Setup
  const dummy1 = new WoW.Content.TargetDummy(600, 200);
  const dummy2 = new WoW.Content.TargetDummy(650, 300);
  const dummy3 = new WoW.Content.TargetDummy(600, 400);
  
  WoW.State.Enemies = [dummy1, dummy2, dummy3];

  // Auto-Target - 所有职业初始不设置目标，需要主动开怪
  warrior.target = null;
  mage.target = null;
  priest.target = null;
  rogue.target = null;
  hunter.target = null;

  // Enemies target warrior by default (战士是默认坦克)
  WoW.State.Enemies.forEach(enemy => enemy.target = warrior);

  // Game Loop
  let lastTime = 0;
  let isPaused = false;

  console.log('Starting game loop...');
  requestAnimationFrame(loop);

  function loop(timestamp) {
      if (isPaused) return;

      try {
          const dt = (timestamp - lastTime) / 1000;
          lastTime = timestamp;

          // Handle Career Selection
          if (careerSelection.isOpen) {
              drawCareerSelection();

              if (careerSelection.update(input)) {
                  // Career selected, set player
                  const selectedCareerId = careerSelection.getSelectedCareer();
                  player = careers[selectedCareerId];
                  WoW.State.Player = player;

                  // Set initial target for selected player
                  player.target = dummy2;

                  // Add mouse input for inventory
                  canvas.addEventListener('mousedown', handleMouseDown);

                  console.log(`玩家选择了: ${careerSelection.getCareerName(selectedCareerId)}`);
              }

              requestAnimationFrame(loop);
              return;
          }

          update(dt);
          draw();

          requestAnimationFrame(loop);
      } catch (e) {
          console.error("Game Loop Error:", e);
          ctx.fillStyle = "red";
          ctx.font = "20px Arial";
          ctx.fillText("GAME CRASHED! Check Console.", 100, 100);
          ctx.fillText(e.message, 100, 130);
          isPaused = true;
      }
  }

  function handleMouseDown(e) {
      if (!player) return;

      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      inventorySystem.handleClick(mouseX, mouseY, player);
  }

  function drawCareerSelection() {
      // 清空画布
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, WoW.Core.Constants.CANVAS_WIDTH, WoW.Core.Constants.CANVAS_HEIGHT);
      careerSelection.draw(ctx);
  }

  // Helper for input debounce
  let lastTabTime = 0;
  let lastPartyTargetTime = 0;
  let lastCareerSwitchTime = 0;

  function update(dt) {
      if (!player) return;

      inventorySystem.update(player);

      if (!inventorySystem.isOpen) {
          const intent = controller.getIntent();

          // Movement
          if (intent.dx !== 0 || intent.dy !== 0) {
              const len = Math.sqrt(intent.dx**2 + intent.dy**2);
              player.x += (intent.dx / len) * player.speed * dt;
              player.y += (intent.dy / len) * player.speed * dt;
          }

          // Skills
          intent.actions.forEach(action => {
              if (action === 'SKILL_1') skillSystem.cast(player, 1, player.target);
              if (action === 'SKILL_2') skillSystem.cast(player, 2, player.target);
              if (action === 'SKILL_3') skillSystem.cast(player, 3, player.target);

              // Target Switching (Tab)
              if (action === 'ACTION_NEXT_TARGET') {
                  const now = Date.now();
                  if (now - lastTabTime > 200) { // Simple debounce
                      lastTabTime = now;
                      switchTarget();
                  }
              }

              // Party Member Target Switching (R)
              if (action === 'ACTION_NEXT_PARTY_TARGET') {
                  const now = Date.now();
                  if (now - lastPartyTargetTime > 200) { // Simple debounce
                      lastPartyTargetTime = now;
                      switchPartyTarget();
                  }
              }

              // Career Switching (6-0 数字键)
              if (action === 'SWITCH_CAREER_1') switchCareer('warrior');
              if (action === 'SWITCH_CAREER_2') switchCareer('mage');
              if (action === 'SWITCH_CAREER_3') switchCareer('priest');
              if (action === 'SWITCH_CAREER_4') switchCareer('rogue');
              if (action === 'SWITCH_CAREER_5') switchCareer('hunter');
          });
      }

      // Update All Units
      warrior.update(dt);
      mage.update(dt);
      priest.update(dt);
      rogue.update(dt);
      hunter.update(dt);

      // Update Enemies
      WoW.State.Enemies.forEach(e => e.update(dt));

      battleSystem.update();
      vfxSystem.update(dt);

      // Sync Party Targets - 只在战士进入战斗时同步，且排除玩家控制的角色
      if (warrior.inCombat && warrior.target && !warrior.target.isDead) {
          if (player !== mage && mage.target !== warrior.target) {
              battleSystem.addDebugLog(`[目标] 牧师 → ${warrior.target.name}`);
              mage.target = warrior.target;
          }
          if (player !== priest && priest.target !== warrior.target) {
              battleSystem.addDebugLog(`[目标] 牧师 → ${warrior.target.name}`);
              priest.target = warrior.target;
          }
          if (player !== rogue && rogue.target !== warrior.target) rogue.target = warrior.target;
          if (player !== hunter && hunter.target !== warrior.target) hunter.target = warrior.target;
      } else {
          // 战士退出战斗时，清除队友的目标（排除玩家）
          if (player !== mage) mage.target = null;
          if (player !== priest) {
              battleSystem.addDebugLog(`[目标] 牧师 → null`);
              priest.target = null;
          }
          if (player !== rogue) rogue.target = null;
          if (player !== hunter) hunter.target = null;
      }
  }

  function switchTarget() {
      const liveEnemies = WoW.State.Enemies.filter(e => !e.isDead);
      if (liveEnemies.length === 0) return;

      let currentIndex = liveEnemies.indexOf(player.target);
      let nextIndex = (currentIndex + 1) % liveEnemies.length;

      player.target = liveEnemies[nextIndex];
  }

  function switchPartyTarget() {
      if (!WoW.State.Party || WoW.State.Party.length === 0) return;

      const livePartyMembers = WoW.State.Party.filter(m => !m.isDead);
      if (livePartyMembers.length === 0) return;

      let currentIndex = livePartyMembers.indexOf(player.target);
      let nextIndex = (currentIndex + 1) % livePartyMembers.length;

      player.target = livePartyMembers[nextIndex];
      console.log(`切换目标到队友: ${player.target.name}`);
  }

  function switchCareer(careerId) {
      const now = Date.now();
      if (now - lastCareerSwitchTime < 500) return; // 防止快速切换
      lastCareerSwitchTime = now;

      if (careers[careerId]) {
          player = careers[careerId];
          WoW.State.Player = player;
          console.log(`切换到: ${careerSelection.getCareerName(careerId)}`);
      }
  }

  function draw() {
      ctx.fillStyle = WoW.Core.Constants.COLORS.FLOOR;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Selection Circle
      if (player.target && !player.target.isDead) {
          const t = player.target;
          ctx.save();
          ctx.translate(t.x + t.width/2, t.y + t.height);
          ctx.scale(1, 0.5);
          ctx.beginPath();
          ctx.arc(0, 0, 30, 0, Math.PI*2);
          // Red for enemies, Green for party members
          const isPartyMember = WoW.State.Party && WoW.State.Party.includes(t);
          ctx.strokeStyle = isPartyMember ? '#00ff00' : '#ff0000';
          ctx.lineWidth = 3;
          ctx.stroke();
          ctx.restore();
      }

      // Draw Enemies
      WoW.State.Enemies.forEach(e => {
          if (!e.isDead) drawUnit(e);
      });

      // Draw Party (Iterate WoW.State.Party to ensure everyone is drawn)
      if (WoW.State.Party) {
          WoW.State.Party.forEach(member => {
              drawUnit(member);
          });
      }

      vfxSystem.draw(ctx);
      battleSystem.draw(ctx);
      drawUI();

      // Draw debug logs
      battleSystem.drawDebugLogs(ctx);

      inventorySystem.draw(ctx, player);
  }

  function drawUnit(unit) {
      ctx.fillStyle = unit.color;
      
      // Effects
      if (unit.hasBuff('盾墙')) {
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 4;
          ctx.strokeRect(unit.x, unit.y, unit.width, unit.height);
      }
      
      ctx.fillRect(unit.x, unit.y, unit.width, unit.height);
      
      // Render Weapon (Only if Main Hand is equipped)
      const mainHandItem = unit.equipment[WoW.Core.Constants.SLOTS.MAIN_HAND];
      if (mainHandItem && mainHandItem.type === 'weapon') {
          ctx.save();
          ctx.translate(unit.x + unit.width/2, unit.y + unit.height/2);
          
          let facingRight = true;
          if (unit.target && unit.target.x < unit.x) facingRight = false;
          if (!facingRight) ctx.scale(-1, 1);

          ctx.fillStyle = mainHandItem.iconColor || '#fff';
          // Simple sword shape
          ctx.beginPath();
          ctx.moveTo(10, 5);
          ctx.lineTo(30, 5);
          ctx.lineTo(35, 0);
          ctx.lineTo(30, -5);
          ctx.lineTo(10, -5);
          ctx.fill();
          
          // Hilt
          ctx.fillStyle = "#4a3b2a";
          ctx.fillRect(5, -8, 5, 16); 
          ctx.fillRect(0, -2, 5, 4); 

          ctx.restore();
      }

      // Name
      ctx.fillStyle = '#fff';
      ctx.font = '12px Arial';
      ctx.fillText(unit.name, unit.x, unit.y - 10);

      // Cast Bar
      if (unit.isCasting && unit.currentCast) {
          const barWidth = unit.width + 10;
          const barHeight = 4;
          const barX = unit.x - 5;
          const barY = unit.y - 25; // 在名字上方
          const progress = unit.castProgress / unit.currentCast.castTime;

          // Background
          ctx.fillStyle = '#333';
          ctx.fillRect(barX, barY, barWidth, barHeight);

          // Fill (purple for casting)
          ctx.fillStyle = '#a855f7';
          ctx.fillRect(barX, barY, barWidth * Math.min(progress, 1), barHeight);

          // Border
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 1;
          ctx.strokeRect(barX, barY, barWidth, barHeight);

          // Spell name
          ctx.fillStyle = '#fff';
          ctx.font = '10px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(unit.currentCast.skill.name, unit.x + unit.width/2, barY - 5);
          ctx.textAlign = 'left';
      }

      // Health Bar on Head
      unit.drawHealthBar(ctx);
  }

  function drawUI() {
      // Player Frame
      drawBar(20, 20, 200, 20, player.hp, player.maxHp, '#e74c3c');
      drawResourceBar(20, 45, 200, 15, player);

      // Player Name & Career
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 16px Microsoft YaHei';
      ctx.textAlign = 'left';
      ctx.fillText(player.name, 230, 35);
      ctx.font = '12px Microsoft YaHei';
      ctx.fillStyle = '#aaa';
      ctx.fillText(`当前控制`, 230, 55);

      // Party Frames (Left Side)
      const startY = 80;
      const gapY = 35;

      // Mage
      let y = startY;
      drawPartyFrame(mage, 20, y, 150, 23, mage === player);

      // Priest
      y += gapY;
      drawPartyFrame(priest, 20, y, 150, 23, priest === player);

      // Rogue
      y += gapY;
      drawPartyFrame(rogue, 20, y, 150, 23, rogue === player);

      // Hunter
      y += gapY;
      drawPartyFrame(hunter, 20, y, 150, 23, hunter === player);

      // Action Bar
      const startX = 250;
      const actionBarY = 500;

      drawAutoAttackIcon(startX, actionBarY, player);
      drawSkill(player.skills[1], startX + 50, actionBarY, '1');
      drawSkill(player.skills[2], startX + 100, actionBarY, '2');
      drawSkill(player.skills[3], startX + 150, actionBarY, '3');

      // Combat Log
      const logX = WoW.Core.Constants.CANVAS_WIDTH - 320;
      const logY = WoW.Core.Constants.CANVAS_HEIGHT - 150;

      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(logX, logY, 300, 140);
      ctx.strokeStyle = "#444";
      ctx.strokeRect(logX, logY, 300, 140);

      ctx.font = "12px Courier New";
      battleSystem.combatLog.forEach((msg, i) => {
          ctx.fillStyle = "#ccc";
          if (msg.includes("死亡")) ctx.fillStyle = "#ff5555";
          if (msg.includes("格挡")) ctx.fillStyle = "#aaaaff";
          if (msg.includes("恢复")) ctx.fillStyle = "#aaffaa";
          ctx.fillText(msg, logX + 10, logY + 20 + (i * 15));
      });

      ctx.fillStyle = "#ffff00";
      ctx.font = "12px Microsoft YaHei";
      ctx.textAlign = 'left';
      ctx.fillText("按 'I' 打开背包 | 按 'Tab' 切换敌人 | 按 'R' 切换队友 | 6-0 切换角色", 10, WoW.Core.Constants.CANVAS_HEIGHT - 10);
  }

  function drawPartyFrame(unit, x, y, w, h, isControlled) {
      // Health Bar
      drawBar(x, y, w, 15, unit.hp, unit.maxHp, '#e74c3c');
      drawResourceBar(x, y + 15, w, 8, unit);

      // Name
      ctx.fillStyle = isControlled ? careerSelection.getCareerColor(unit.name.toLowerCase()) : '#fff';
      ctx.font = isControlled ? 'bold 11px Microsoft YaHei' : '10px Microsoft YaHei';
      ctx.textAlign = 'left';
      ctx.fillText(unit.name, x + 5, y + 11);

      // Control indicator
      if (isControlled) {
          ctx.strokeStyle = '#00ff00';
          ctx.lineWidth = 2;
          ctx.strokeRect(x - 2, y - 2, w + 4, h + 4);
      }
  }

  function drawBar(x, y, w, h, val, max, color) {
      ctx.fillStyle = '#333';
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = color;
      ctx.fillRect(x, y, Math.max(0, (val/max)*w), h);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1;
      ctx.strokeRect(x, y, w, h);
  }
  
  function drawResourceBar(x, y, w, h, unit) {
      let color = '#ccc';
      if (unit.resourceType === 'rage') color = WoW.Core.Constants.COLORS.WARRIOR_RAGE; 
      if (unit.resourceType === 'mana') color = '#3498db'; 
      if (unit.resourceType === 'energy') color = WoW.Core.Constants.COLORS.ROGUE_ENERGY;
      if (unit.resourceType === 'focus') color = WoW.Core.Constants.COLORS.HUNTER_FOCUS;
      
      ctx.fillStyle = '#333';
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = color;
      const res = unit.resource || 0;
      const max = unit.maxResource || 1;
      ctx.fillRect(x, y, Math.max(0, (res / max)*w), h);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1;
      ctx.strokeRect(x, y, w, h);
  }

  function drawAutoAttackIcon(x, y, unit) {
      ctx.fillStyle = '#222';
      ctx.fillRect(x, y, 40, 40);
      if (unit.swingTimer > 0) {
          ctx.fillStyle = '#555'; 
          const h = (unit.swingTimer / unit.swingSpeed) * 40;
          ctx.fillRect(x, y + 40 - h, 40, h);
      } else {
          ctx.fillStyle = '#fff'; 
          ctx.fillRect(x + 2, y + 2, 36, 36);
      }
      ctx.fillStyle = '#000';
      ctx.font = 'bold 20px Arial';
      ctx.fillText("⚔️", x + 8, y + 28);
      ctx.strokeStyle = '#fff';
      ctx.strokeRect(x, y, 40, 40);
      ctx.fillStyle = '#fff';
      ctx.font = '10px Arial';
      ctx.fillText("普攻", x + 8, y + 52); 
  }

  function drawSkill(skill, x, y, key) {
      ctx.fillStyle = '#222';
      ctx.fillRect(x, y, 40, 40);
      
      // 如果技能不存在（该职业没有这个技能位），则只绘制空背景和按键提示
      if (!skill) {
          ctx.strokeStyle = '#333';
          ctx.strokeRect(x, y, 40, 40);
          ctx.fillStyle = '#666';
          ctx.font = 'bold 14px Arial';
          ctx.fillText(key, x + 2, y + 12);
          return;
      }

      if (skill.currentCd > 0) {
          ctx.fillStyle = '#444';
          const h = (skill.currentCd / skill.cd) * 40;
          ctx.fillRect(x, y + 40 - h, 40, h);
      } else {
          ctx.fillStyle = skill.color;
          ctx.fillRect(x+2, y+2, 36, 36);
      }
      ctx.strokeStyle = '#555';
      ctx.strokeRect(x, y, 40, 40);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 14px Arial';
      ctx.fillText(key, x+2, y+12);
      ctx.font = '10px Arial';
      ctx.fillText(skill.name, x, y + 52);
  }

}; // End of window.onload